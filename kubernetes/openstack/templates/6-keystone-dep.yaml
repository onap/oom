apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: keystone
  namespace: "{{ .Values.nsPrefix }}-openstack"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "6"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  selector:
    matchLabels:
      app: keystone
  template:
    metadata:
      labels:
        app: keystone
      name: keystone
    spec:
      hostname: keystone
      containers:
      - image: {{ .Values.image.keystone }}:{{ .Values.kollaTag}}
        name: keystone
        ports:
        - containerPort: 35357
        - containerPort: 5000
        readinessProbe:
          tcpSocket:
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 10
        volumeMounts:
        - mountPath: /var/lib/kolla/config_files/
          name: config-files
        env:
        - name: KOLLA_SERVICE_NAME
          value: keystone
        - name: KOLLA_CONFIG_STRATEGY
          value: COPY_ALWAYS
        - name: PATH
          value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        - name: PIP_INDEX_URL
          value: http://mirror.kna1.citycloud.openstack.org:8080/pypi/simple
        - name: PIP_TRUSTED_HOST
          value: mirror.kna1.citycloud.openstack.org
        - name: KOLLA_BASE_DISTRO
          value: ubuntu
        - name: KOLLA_INSTALL_TYPE
          value: binary
        - name: KOLLA_INSTALL_METATYPE
          value: rdo
        - name: DEBIAN_FRONTEND
          value: noninteractive
        - name: DB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: credentials
              key: dbPassword
        - name: OS_PROJECT_DOMAIN_NAME
          value: default
        - name: OS_USER_DOMAIN_NAME
          value: default
        - name: OS_PROJECT_NAME
          value: admin
        - name: OS_TENANT_NAME
          value: admin
        - name: OS_USERNAME
          value: admin
        - name: OS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: credentials
              key: osPassword
        - name: OS_AUTH_URL
          value: http://keystone:35357/v3
        - name: OS_IDENTITY_API_VERSION
          value: "3"

      volumes:
        - name: config-files
          hostPath:
            path: /dockerdata-nfs/{{ .Values.nsPrefix }}/openstack/keystone
