apiVersion: batch/v1
kind: Job
metadata:
  name: kcadmjob
spec:
  template:
    spec:
      containers:
      {{- $global := . }}
      - name: kcadmjob
        image: kcadmjob:latest
        imagePullPolicy: Never
        command:
          - "sh"
          - "-c"
          - |-
            {{ $realm := .Values.keycloak.realm -}}
            export PATH="/keycloak/bin:${PATH}"
            kcadm.sh config credentials \
            --server 'http://{{ .Values.keycloak.domain }}/auth' \
            --realm master \
            --user {{ .Values.keycloak.user }} --password {{ .Values.keycloak.password }} || exit 1
            kcadm.sh create realms -s realm={{ $realm }} -s enabled=true
            {{- range $secret := .Values.secrets }}
            {{- if ne .uid "keycloak-secret" }}
            kcadm.sh create users -r {{ $realm }} -s username={{ $secret.login }} -s enabled=true -o --fields id,username
            kcadm.sh set-password --username {{ $secret.login }} --new-password "${{ $secret.uid }}" -r {{ $realm }}
            {{- end }}
            {{- end }}
        env:
        {{- range $global.Values.secrets }}
        {{- if ne .uid "keycloak-secret" }}
        - name: {{ .uid }}
          {{- include "common.secret.envFromSecretFast" (dict "global" $global "uid" .uid "key" "password") | indent 10 }}
        {{- end }}
        {{- end }}
      restartPolicy: Never